// Portfolio AI Stack Data Flow
digraph portfolio_ai_stack_flow {
	nodesep=0.5 rankdir=TB ranksep=0.7 ratio=fill size="11,8"
	node [fontname=Arial fontsize=12 margin="0.2,0.1" shape=box style="filled,rounded"]
	edge [fontname=Arial fontsize=10]
	subgraph cluster_external {
		color="#3498DB" fillcolor="#EBF5FB" label="External Data Sources" style="filled,rounded"
		alpaca [label="Alpaca API
(Market Data)" color="#2E86C1" fillcolor="#D6EAF8"]
		fed [label="Fed APIs
(Economic Data)" color="#2E86C1" fillcolor="#D6EAF8"]
		edgar [label="SEC EDGAR
(Financial Documents)" color="#2E86C1" fillcolor="#D6EAF8"]
		user_data [label="User & Portfolio Data" color="#2E86C1" fillcolor="#D6EAF8"]
	}
	subgraph cluster_ingestion {
		color="#2ECC71" fillcolor="#EAFAF1" label="Data Ingestion Layer" style="filled,rounded"
		market_pipeline [label="Market Data Pipeline
(src/data/market_data_service.py)" color="#27AE60" fillcolor="#D5F5E3"]
		econ_pipeline [label="Economic Data Pipeline
(src/data/economic_data_service.py)" color="#27AE60" fillcolor="#D5F5E3"]
		doc_pipeline [label="Document Processing
(ETL & Extraction)" color="#27AE60" fillcolor="#D5F5E3"]
	}
	subgraph cluster_retrieval {
		color="#F1C40F" fillcolor="#FEF9E7" label="Context Retrieval Layer" style="filled,rounded"
		query_processor [label="Query Processor
(src/rag/query_processor.py)" color="#F39C12" fillcolor="#FCF3CF"]
		retriever [label="Enhanced Retriever
(src/rag/retriever.py)" color="#F39C12" fillcolor="#FCF3CF"]
		context_retriever [label="Context Retriever
(src/langgraph_engine/context_retriever.py)" color="#F39C12" fillcolor="#FCF3CF"]
	}
	subgraph cluster_graph {
		color="#CB4335" fillcolor="#FDEDEC" label="LangGraph Engine" style="filled,rounded"
		"graph" [label="Portfolio Graph
(src/langgraph_engine/graph.py)" color="#E74C3C" fillcolor="#FADBD8"]
		decision_maker [label="Decision Maker
(src/langgraph_engine/decision_maker.py)" color="#E74C3C" fillcolor="#FADBD8"]
	}
	subgraph cluster_storage {
		color="#9B59B6" fillcolor="#F4ECF7" label="Data Storage Layer" style="filled,rounded"
		pinecone [label="Pinecone
(Vector Database)" color="#8E44AD" fillcolor="#E8DAEF"]
		supabase [label="Supabase
(User & Portfolio Data)" color="#8E44AD" fillcolor="#E8DAEF"]
		timescale [label="TimeScaleDB
(Time-Series Data)" color="#8E44AD" fillcolor="#E8DAEF"]
	}
	cli [label="Portfolio Advisor CLI
(portfolio_advisor.py)" color="#E67E22" fillcolor="#FDEBD0" style="filled,rounded"]
	alpaca -> market_pipeline [label="OHLCV, Order Books"]
	fed -> econ_pipeline [label="Interest Rates, Inflation"]
	edgar -> doc_pipeline [label="Prospectuses, Reports"]
	user_data -> cli [label="User Queries"]
	market_pipeline -> pinecone [label="Market Knowledge"]
	market_pipeline -> timescale [label="Price History"]
	econ_pipeline -> pinecone [label="Economic Indicators"]
	econ_pipeline -> timescale [label="Economic Time Series"]
	doc_pipeline -> pinecone [label="Document Embeddings"]
	pinecone -> retriever [label="Vector Search"]
	supabase -> context_retriever [label="User Profile Data"]
	timescale -> context_retriever [label="Time Series Data"]
	query_processor -> retriever [label="Processed Query"]
	retriever -> context_retriever [label="Raw Contexts"]
	context_retriever -> "graph" [label="Enhanced Contexts"]
	"graph" -> decision_maker [label="State & Contexts"]
	decision_maker -> "graph" [label="Decision Output"]
	cli -> query_processor [label="User Query"]
	"graph" -> cli [label="Portfolio Decision"]
}
